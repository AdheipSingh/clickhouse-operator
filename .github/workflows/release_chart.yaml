name: release_chart

on:
  release:
    types: [ created ]

jobs:
  release_chart:
    name: Release Chart
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Install chart-releaser
        run: |
          wget https://github.com/helm/chart-releaser/releases/download/v1.4.1/chart-releaser_1.4.1_linux_amd64.tar.gz
          tar -zxf chart-releaser_1.4.1_linux_amd64.tar.gz cr
          sudo install cr /usr/local/bin/
          rm -f cr chart-releaser_1.4.1_linux_amd64.tar.gz
      - name: Package Chart
        run: cr package deploy/helm
      - name: Upload Release artifacts
        uses: skx/github-action-publish-binaries@release-2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: '.cr-release-packages/*.tgz'
      - name: Release chart
        run: |
          git remote add httpsorigin "https://github.com/${GITHUB_REPOSITORY}.git"
          git fetch httpsorigin
          cr index \
            --git-repo=${GITHUB_REPOSITORY#*/} \
            --owner=${GITHUB_REPOSITORY_OWNER} \
            --release-name-template=${{ github.event.release.name }} \
            --token=${{ secrets.GITHUB_TOKEN }}  \
            --index-path=index.yaml \
            --remote=httpsorigin \
            --push
